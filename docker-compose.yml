services:
  kafka:
    image: bitnami/kafka:3.7
    container_name: kafka
    ports:
      - "9092:9092"
    environment:
      # KRaft mode (no Zookeeper)
      - KAFKA_CFG_NODE_ID=1
      - KAFKA_CFG_PROCESS_ROLES=broker,controller
      - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=1@kafka:9093
      - KAFKA_CFG_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092
      - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=PLAINTEXT:PLAINTEXT,CONTROLLER:PLAINTEXT
      - KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_CFG_INTER_BROKER_LISTENER_NAME=PLAINTEXT
      - KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE=true
      - ALLOW_PLAINTEXT_LISTENER=yes
    healthcheck:
      test: ["CMD-SHELL", "kafka-topics.sh --bootstrap-server kafka:9092 --list >/dev/null 2>&1 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 20

  postgres:
    image: postgres:16
    container_name: postgres
    environment:
      - POSTGRES_USER=fraud
      - POSTGRES_PASSWORD=fraud
      - POSTGRES_DB=frauddb
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data

  flink-jobmanager:
    image: flink:1.19.1-scala_2.12-java17
    container_name: flink-jobmanager
    command: jobmanager
    ports:
      - "8081:8081"
    environment:
      - |
        FLINK_PROPERTIES=
        jobmanager.rpc.address: flink-jobmanager
        parallelism.default: 1

  flink-taskmanager:
    image: flink:1.19.1-scala_2.12-java17
    container_name: flink-taskmanager
    command: taskmanager
    depends_on:
      - flink-jobmanager
    environment:
      - |
        FLINK_PROPERTIES=
        jobmanager.rpc.address: flink-jobmanager
        taskmanager.numberOfTaskSlots: 2
        parallelism.default: 1

  backend:
    build: ./backend
    container_name: backend
    depends_on:
      kafka:
        condition: service_healthy
      postgres:
        condition: service_started
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - DATABASE_URL=postgresql+psycopg://fraud:fraud@postgres:5432/frauddb
      - MLFLOW_MODEL_URI=models:/fraud_iforest/latest
      - EVENT_SIGNING_SECRET=KAFKA_EVENT_SECRET_CHANGE_ME

    ports:
      - "8000:8000"

  frontend:
    build: ./frontend
    container_name: frontend
    depends_on:
      - backend
    ports:
      - "5173:5173"

volumes:
  pgdata:
  txn-generator:
    build: ./backend
    container_name: txn-generator
    depends_on:
      kafka:
        condition: service_healthy
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - EVENT_SIGNING_SECRET=KAFKA_EVENT_SECRET_CHANGE_ME

    command: ["python", "-m", "app.generator"]



  mlflow:
    image: python:3.11-slim
    container_name: mlflow
    working_dir: /mlflow
    volumes:
      - ./mlruns:/mlflow/mlruns
    ports:
      - "8080:8080"
    command: >
      bash -lc "pip install --no-cache-dir mlflow==2.19.0 &&
      mlflow server --host 0.0.0.0 --port 8080
      --backend-store-uri file:/mlflow/mlruns
      --default-artifact-root file:/mlflow/mlruns"
